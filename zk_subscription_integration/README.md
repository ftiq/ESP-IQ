# مديول تكامل نظام البصمة ZK مع اشتراكات Odoo 18 Enterprise

## نظرة عامة
يهدف هذا المديول إلى ربط نظام البصمة ZK-Teco بمنصة Odoo 18 Enterprise لإدارة صلاحية الوصول بناءً على حالة الاشتراكات. يتم تعطيل بصمة العميل تلقائيًا عند انتهاء الاشتراك، وإعادة تفعيلها عند التجديد، عبر آلية تزامن تعتمد على معرّف العميل الفريد.

## المميزات الرئيسية
- ربط أجهزة البصمة ZK-Teco مع نظام اشتراكات Odoo 18
- تعطيل بصمات العملاء تلقائياً عند انتهاء الاشتراك
- إعادة تفعيل البصمات عند تجديد الاشتراك
- إدارة مركزية لأجهزة البصمة المتصلة
- توافق كامل مع هيكل الاشتراكات الجديد في Odoo 18

## متطلبات النظام
- Odoo 18 Enterprise
- وحدة المبيعات (sale) ووحدة الاشتراكات (sale_subscription) مثبتة
- أجهزة بصمة ZK-Teco تدعم وضع ADMS
- اتصال شبكة بين خادم Odoo وأجهزة البصمة

## دليل التثبيت
1. قم بتنزيل المديول وضعه في مجلد `custom_addons` الخاص بتثبيت Odoo
2. أعد تشغيل خدمة Odoo
3. قم بتسجيل الدخول إلى Odoo، وانتقل إلى التطبيقات وابحث عن "تكامل نظام البصمة ZK مع الاشتراكات"
4. قم بتثبيت المديول

## دليل الاستخدام
### 1. إعداد أجهزة البصمة
1. انتقل إلى `الاشتراكات > أجهزة البصمة` وانقر على "إنشاء"
2. أدخل المعلومات المطلوبة:
   - اسم الجهاز: مثال "جهاز استقبال الرئيسي"
   - عنوان IP: مثال "192.168.1.100"
   - رقم المنفذ: الافتراضي هو 4370
   - موقع الجهاز: مثال "المدخل الرئيسي"
3. اختباري: انقر على زر "اختبار الاتصال" للتأكد من صحة الإعدادات

#### مثال إعداد جهاز بصمة
```
اسم الجهاز: جهاز استقبال المركز الصحي
عنوان IP: 192.168.1.100
رقم المنفذ: 4370
استخدام HTTPS: لا
موقع الجهاز: مدخل العيادات
```

### 2. ربط العملاء بمعرفات البصمة
1. انتقل إلى `العملاء > العملاء` واختر العميل المطلوب
2. انتقل إلى تبويب "بصمة ZK"
3. أدخل معرّف البصمة الخاص بالعميل في حقل "معرّف البصمة"
4. تأكد من أن حالة البصمة هي "مفعلة"

#### مثال ربط عميل بمعرف بصمة
```
اسم العميل: محمد أحمد
معرّف البصمة: 00123
حالة البصمة: مفعلة
```

### 3. تحقق من حالة الاشتراكات وتأثيرها على البصمات
1. عند انتهاء اشتراك العميل، سيتم تعطيل بصمته تلقائيًا من خلال الإجراء المجدول اليومي
2. عند تجديد الاشتراك، ستتم إعادة تفعيل البصمة تلقائيًا

#### مثال لتجديد اشتراك
1. افتح اشتراك منتهي للعميل "محمد أحمد"
2. قم بتعديل تاريخ التجديد التالي إلى تاريخ مستقبلي
3. احفظ الاشتراك
4. لاحظ أن حالة البصمة في بطاقة العميل ستتغير إلى "مفعلة"

### 4. مزامنة يدوية للبصمات
1. انتقل إلى `الاشتراكات > أجهزة البصمة` واختر الجهاز المطلوب
2. انقر على زر "مزامنة المستخدمين" لمزامنة جميع البصمات مع حالة الاشتراكات

## سيناريوهات عملية
### سيناريو 1: انتهاء اشتراك عميل
عند انتهاء اشتراك العميل "محمد أحمد" (معرّف البصمة: 00123):
1. يقوم النظام تلقائيًا بمراقبة تاريخ انتهاء الاشتراك
2. عند تجاوز تاريخ اليوم لتاريخ التجديد التالي، يقوم النظام بتعطيل البصمة
3. يتم إرسال أمر إلى جهاز البصمة لمنع دخول العميل
4. تتغير حالة البصمة في نظام Odoo إلى "معطلة"

### سيناريو 2: تجديد اشتراك منتهي
عند تجديد اشتراك العميل "محمد أحمد" بعد انتهائه:
1. يقوم موظف الاستقبال بتجديد الاشتراك في النظام
2. يقوم النظام تلقائيًا بتفعيل البصمة
3. يتم إرسال أمر إلى جهاز البصمة للسماح بدخول العميل
4. تتغير حالة البصمة في نظام Odoo إلى "مفعلة"

## استكشاف الأخطاء وإصلاحها
### مشكلة: فشل الاتصال بجهاز البصمة
**الحل المحتمل**:
- تأكد من صحة عنوان IP ورقم المنفذ
- تأكد من فتح منفذ الاتصال في جدار الحماية
- تحقق من إعدادات ADMS في جهاز البصمة

### مشكلة: عدم تعطيل البصمة بعد انتهاء الاشتراك
**الحل المحتمل**:
- تأكد من تشغيل الإجراء المجدول "تعطيل بصمات العملاء للاشتراكات المنتهية"
- تحقق من وجود معرّف البصمة في بطاقة العميل
- تأكد من أن الاشتراك مرتبط بالعميل الصحيح


